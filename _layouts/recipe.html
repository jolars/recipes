---
layout: base
---

{%- assign servings_size = page.servings | split: ' ' | first -%}
<script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "Recipe",
        "author": "{{page.author}}",
        {%- if page.prep_time -%}
            "prepTime": "{{ page.prep_time }}",
        {%- endif -%}
        {%- if page.cook_time -%}
            "cookTime": "{{ page.cook_time }}",
        {%- endif -%}
        "description": "{{page.excerpt}}",
        "image": "{{ page.img | absolute_url }}",
        "recipeIngredient": [
            {%- for part in page.ingredients -%}
                {% for ingredient in part[1] %}
                "{% if ingredient.name %}{{ ingredient.amount }} {{ ingredient.name }}{% else %}{{ ingredient | replace_regex: '\\[([^\\]]+)\\]\\([^\\)]+\\)', '\\1' }}{% endif %}"{% unless forloop.last and forloop.parentloop.last %},{% endunless %}
                {%- endfor %}
            {%- endfor %}
        ],
        "name": "{{ page.title }}",
"prepTime": "{{ page.prep_time }}",
        "recipeInstructions": "{{ content | strip_html | strip_newlines | strip | escape | replace: '"', '\"' }}",
        "recipeYield": "{{ page.servings }}",
        "suitableForDiet": "https://schema.org/LowFatDiet"
    }
</script>
<div class="row pb-3">
    <div class="col-sm-12 col-xl-11 offset-xl-1">
        <div class="pb-4">
            {% if page.img %}
                {%
                picture "{{ page.img }}"
                20:4
                --alt {{ page.title }}
                --img class="img-fluid rounded"
                %}
            {% endif %}
        </div>
        <h1>{{ page.title }}</h1>
        <p class="lead">{{ page.excerpt }}</p>
        <p>{{ page.description }}</p>
    </div>
</div>
<div class="recipe row">
    <div class="ingredients col-sm-4 col-lg-5 col-xl-4 offset-xl-1">
        <div class="row align-items-start">
            <div class="col">
                <h3>Ingredienser</h3>
            </div>
            {%- if page.servings -%}
                <div class="col">
                    <div class="mb-2 text-center">
                        <em class="text-body-secondary me-2"><span id="servings" data-servings="{{ servings_size }}">{{ page.servings }}</span></em>
                        <div class="btn-group btn-group-sm"
                             role="group"
                             aria-label="Modify Servings Buttons">
                            <a class="btn btn-outline-danger" onclick="modifyServings('down');">
                                <i class="bi bi-dash"></i>
                            </a>
                            <a class="btn btn-outline-success" onclick="modifyServings('up');">
                                <i class="bi bi-plus"></i>
                            </a>
                        </div>
                    </div>
                </div>
            {%- endif -%}
        </div>
        {% for part in page.ingredients %}
            {%- if part[0] != "main" -%}
                <h4>{{ part[0] }}</h4>
            {%- endif -%}
            <ul class="list-unstyled">
                {% for ingredient in part[1] %}
                <li>
                    <span class="ingredient" data-ingredient="{% if ingredient.name %}{{ ingredient.amount }} {{ ingredient.name }}{% else %}{{ ingredient }}{% endif %}">
                    {% if ingredient.name %}
                        {% if ingredient.link %}
                        {%- assign ingredient_url = ingredient.link -%}
                        {%- unless ingredient.link contains '/' -%}
                            {%- assign ingredient_url = '/recipes/' | append: ingredient.link | append: '/' -%}
                        {%- endunless -%}
                        {%- if ingredient.servings -%}
                            {%- if ingredient_url contains '?' -%}
                                {%- assign ingredient_url = ingredient_url | append: '&servings=' | append: ingredient.servings -%}
                            {%- else -%}
                                {%- assign ingredient_url = ingredient_url | append: '?servings=' | append: ingredient.servings -%}
                            {%- endif -%}
                        {%- endif -%}
                        {{ ingredient.amount }} <a href="{{ ingredient_url }}">{{ ingredient.name }}</a>
                        {% else %}
                        {{ ingredient.amount }} {{ ingredient.name }}
                        {% endif %}
                    {% else %}
                        {{ ingredient | markdownify | remove: '<p>' | remove: '</p>' | strip }}
                    {% endif %}
                    </span>
                </li>
                {% endfor %}
            </ul>
        {% endfor %}
        <div class="d-grid d-sm-block">
            <!-- TODO: Add requestedQuantity and update using javascript -->
            <button class="btn btn-sm btn-outline-primary mb-2" id="bringBtn" onclick="openBringDeeplink()" style="display: none;">
                <i class="bi bi-cart4"></i>
                Lägg till i Bring!
            </button>
            <button class="btn btn-sm btn-outline-secondary mb-2" id="addToMealPlanBtn" onclick="addRecipeToMealPlan()">
                <i class="bi bi-calendar-plus"></i>
                Lägg till i veckomeny
            </button>
            <a href="https://github.com/{{ site.github_username }}/{{ site.repository_name }}/edit/{{ site.branch }}/{{ page.path }}"
               class="btn btn-sm btn-outline-secondary mb-2">
                <i class="bi bi-pencil"></i> Edit on GitHub
            </a>
        </div>

        <script>
        let wakeLock = null;

        // Show Bring button only on mobile/tablet devices
        if (/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)) {
            document.getElementById('bringBtn').style.display = '';
        }

        function openBringDeeplink() {
            // Get current servings from the page (may be adjusted via URL parameter or +/- buttons)
            const servingsElement = document.getElementById('servings');
            const currentServings = servingsElement ? parseInt(servingsElement.textContent.match(/\d+/)[0]) : {{ servings_size }};

            const bringUrl = 'https://api.getbring.com/rest/bringrecipes/deeplink?url={{ page.url | absolute_url }}&source=web&baseQuantity=' + currentServings;
            // Use location.replace to avoid adding to browser history
            location.replace(bringUrl);
        }

        async function toggleScreenWakeLock() {
            const checkbox = document.getElementById('keepScreenOnSwitch');

            if (!('wakeLock' in navigator)) {
                alert('Din webbläsare stöder inte funktionen "håll skärmen på".');
                checkbox.checked = false;
                return;
            }

            if (checkbox.checked) {
                try {
                    wakeLock = await navigator.wakeLock.request('screen');
                    console.log('Screen Wake Lock aktiverad');

                    // Listen for release
                    wakeLock.addEventListener('release', () => {
                        console.log('Screen Wake Lock släppt');
                        checkbox.checked = false;
                    });
                } catch (err) {
                    console.error('Screen Wake Lock misslyckades:', err);
                    checkbox.checked = false;
                    alert('Kunde inte hålla skärmen på: ' + err.message);
                }
            } else {
                if (wakeLock !== null) {
                    try {
                        await wakeLock.release();
                        wakeLock = null;
                        console.log('Screen Wake Lock inaktiverad');
                    } catch (err) {
                        console.error('Kunde inte släppa Screen Wake Lock:', err);
                    }
                }
            }
        }

        // Release wake lock when page is hidden/closed
        document.addEventListener('visibilitychange', async () => {
            if (wakeLock !== null && document.visibilityState === 'hidden') {
                await wakeLock.release();
                wakeLock = null;
            }
        });

        function addRecipeToMealPlan() {
            const recipeSlug = "{{ page.slug }}";
            const servingsElement = document.getElementById('servings');
            const servings = servingsElement ? parseInt(servingsElement.textContent.match(/\d+/)[0]) : {{ servings_size }};

            // Load existing meal plan from localStorage
            let mealPlan = {};
            const saved = localStorage.getItem('mealPlan');
            if (saved) {
                try {
                    mealPlan = JSON.parse(saved);
                } catch (e) {
                    console.error('Failed to parse meal plan:', e);
                }
            }

            // Find the first available day slot
            const dayKeys = ['mon', 'tue', 'wed', 'thu', 'fri', 'sat', 'sun'];
            let targetDay = null;
            for (let dayKey of dayKeys) {
                if (!mealPlan[dayKey]) {
                    targetDay = dayKey;
                    break;
                }
            }

            if (!targetDay) {
                alert('Veckomeny är full! Gå till veckomenyn för att redigera.');
                return;
            }

            // Add this recipe to the first available day
            mealPlan[targetDay] = {
                recipe: recipeSlug,
                servings: servings
            };

            // Save back to localStorage
            localStorage.setItem('mealPlan', JSON.stringify(mealPlan));

            // Visual feedback
            const btn = document.getElementById('addToMealPlanBtn');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="bi bi-check"></i> Tillagd!';
            btn.classList.add('btn-success');
            btn.classList.remove('btn-outline-secondary');
            setTimeout(() => {
                btn.innerHTML = originalText;
                btn.classList.remove('btn-success');
                btn.classList.add('btn-outline-secondary');
            }, 2000);
        }

        // Check for servings URL parameter and adjust servings automatically
        function applyServingsFromURL() {
            const urlParams = new URLSearchParams(window.location.search);
            const servingsParam = urlParams.get('servings');

            if (servingsParam) {
                const targetServings = parseInt(servingsParam);
                const servingsElement = document.getElementById('servings');

                if (servingsElement && targetServings > 0) {
                    const originalServings = parseInt(servingsElement.getAttribute('data-servings'));
                    const currentServingsText = servingsElement.innerHTML;
                    const servingsType = currentServingsText.match(/\d+\s*(.*)/)[1].trim();

                    // Directly set the servings and calculate ingredient amounts
                    const multiplier = targetServings / originalServings;
                    servingsElement.innerHTML = targetServings + " " + servingsType;

                    // Update all ingredients
                    const ingredients = document.getElementsByClassName("ingredient");
                    for (let i = 0; i < ingredients.length; i++) {
                        const originalAmount = ingredients[i].getAttribute("data-ingredient");
                        ingredients[i].innerHTML = updateIngredientAmount(originalAmount, multiplier);
                    }
                }
            }
        }

        // Apply servings from URL on page load
        window.addEventListener('DOMContentLoaded', applyServingsFromURL);
        </script>
    </div>
    <div class="directions col-sm-8 col-lg-7 col-xl-6">
        <div class="row align-items-end mb-3 mt-3 mt-sm-0">
            <div class="col">
                <h3 class="mb-0 mt-sm-0">Instruktioner</h3>
            </div>
            <div class="col">
                <div class="form-check form-switch mb-0 mt-2">
                    <input class="form-check-input" type="checkbox" id="keepScreenOnSwitch" onchange="toggleScreenWakeLock()">
                    <label class="form-check-label" for="keepScreenOnSwitch">
                        <i class="bi bi-lightbulb"></i> Håll skärmen på
                    </label>
                </div>
            </div>
        </div>
        <div id="recipe-instructions">
        {{ content }}
        </div>
        <script>
        // Timer management
        const activeTimers = new Map();

        function createTimer(minutes, stepIndex) {
            const timerKey = `timer-${stepIndex}-${minutes}`;
            const totalSeconds = minutes * 60;

            const timerEl = document.createElement('span');
            timerEl.className = 'recipe-timer';
            timerEl.setAttribute('data-timer-key', timerKey);

            const display = document.createElement('span');
            display.className = 'timer-display';
            display.textContent = formatTime(totalSeconds);

            const startBtn = document.createElement('button');
            startBtn.className = 'timer-btn timer-start';
            startBtn.innerHTML = '▶';
            startBtn.title = 'Start';

            const pauseBtn = document.createElement('button');
            pauseBtn.className = 'timer-btn timer-pause';
            pauseBtn.innerHTML = '⏸';
            pauseBtn.title = 'Paus';
            pauseBtn.style.display = 'none';

            const resetBtn = document.createElement('button');
            resetBtn.className = 'timer-btn timer-reset';
            resetBtn.innerHTML = '↻';
            resetBtn.title = 'Återställ';

            timerEl.appendChild(display);
            timerEl.appendChild(startBtn);
            timerEl.appendChild(pauseBtn);
            timerEl.appendChild(resetBtn);

            // Timer state
            let remainingSeconds = totalSeconds;
            let intervalId = null;
            let isRunning = false;

            function formatTime(seconds) {
                const mins = Math.floor(seconds / 60);
                const secs = seconds % 60;
                return `${mins}:${secs.toString().padStart(2, '0')}`;
            }

            function updateDisplay() {
                display.textContent = formatTime(remainingSeconds);
                if (remainingSeconds === 0) {
                    display.classList.add('timer-finished');
                    display.classList.remove('timer-running');
                    playTimerSound();
                    stop();
                } else if (isRunning) {
                    display.classList.add('timer-running');
                    display.classList.remove('timer-finished');
                } else {
                    display.classList.remove('timer-running', 'timer-finished');
                }
            }

            function start() {
                if (isRunning) return;
                isRunning = true;
                startBtn.style.display = 'none';
                pauseBtn.style.display = 'inline-block';

                intervalId = setInterval(() => {
                    remainingSeconds--;
                    updateDisplay();

                    if (remainingSeconds <= 0) {
                        stop();
                    }
                }, 1000);

                updateDisplay();
            }

            function pause() {
                if (!isRunning) return;
                isRunning = false;
                clearInterval(intervalId);
                startBtn.style.display = 'inline-block';
                pauseBtn.style.display = 'none';
                updateDisplay();
            }

            function stop() {
                isRunning = false;
                clearInterval(intervalId);
                startBtn.style.display = 'inline-block';
                pauseBtn.style.display = 'none';
            }

            function reset() {
                stop();
                remainingSeconds = totalSeconds;
                updateDisplay();
            }

            function playTimerSound() {
                // Create a simple beep using Web Audio API
                try {
                    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    const oscillator = audioContext.createOscillator();
                    const gainNode = audioContext.createGain();

                    oscillator.connect(gainNode);
                    gainNode.connect(audioContext.destination);

                    oscillator.frequency.value = 800;
                    oscillator.type = 'sine';

                    gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);

                    oscillator.start(audioContext.currentTime);
                    oscillator.stop(audioContext.currentTime + 0.5);
                } catch (e) {
                    console.log('Could not play timer sound:', e);
                }
            }

            startBtn.addEventListener('click', start);
            pauseBtn.addEventListener('click', pause);
            resetBtn.addEventListener('click', reset);

            // Store in active timers
            activeTimers.set(timerKey, { start, pause, reset, stop });

            return timerEl;
        }

        function initializeTimers() {
            const instructions = document.querySelector('#recipe-instructions ol');
            if (!instructions) return;

            const steps = instructions.querySelectorAll('li');
            steps.forEach((step, index) => {
                // Get the step content wrapper (created by checkbox init)
                const stepContent = step.querySelector('.step-content');
                if (!stepContent) return;

                // Look for [timer:X] pattern where X is minutes
                const timerPattern = /\[timer:(\d+)\]/g;
                const textContent = stepContent.textContent;

                if (!timerPattern.test(textContent)) return;

                // Reset regex
                timerPattern.lastIndex = 0;

                // Walk through text nodes and replace [timer:X] with actual timer elements
                const walker = document.createTreeWalker(
                    stepContent,
                    NodeFilter.SHOW_TEXT,
                    null
                );

                const nodesToReplace = [];
                let node;

                while (node = walker.nextNode()) {
                    const matches = [...node.textContent.matchAll(/\[timer:(\d+)\]/g)];
                    if (matches.length > 0) {
                        nodesToReplace.push({ node, matches });
                    }
                }

                // Replace text nodes with timer elements
                nodesToReplace.forEach(({ node, matches }) => {
                    const parent = node.parentNode;
                    let lastIndex = 0;
                    const fragment = document.createDocumentFragment();

                    matches.forEach(match => {
                        const matchIndex = match.index;
                        const minutes = parseInt(match[1]);

                        // Add text before the timer
                        if (matchIndex > lastIndex) {
                            fragment.appendChild(
                                document.createTextNode(node.textContent.substring(lastIndex, matchIndex))
                            );
                        }

                        // Add the timer element
                        fragment.appendChild(createTimer(minutes, index));

                        lastIndex = matchIndex + match[0].length;
                    });

                    // Add remaining text after the last timer
                    if (lastIndex < node.textContent.length) {
                        fragment.appendChild(
                            document.createTextNode(node.textContent.substring(lastIndex))
                        );
                    }

                    parent.replaceChild(fragment, node);
                });
            });
        }

        // Add checkboxes to recipe steps for completion tracking
        function initializeStepCheckboxes() {
            const instructions = document.querySelector('#recipe-instructions ol');
            if (!instructions) return;

            const steps = instructions.querySelectorAll('li');
            const recipeSlug = "{{ page.slug }}";
            const storageKey = `recipe-progress-${recipeSlug}`;

            // Load saved progress from localStorage
            let savedProgress = {};
            try {
                const saved = localStorage.getItem(storageKey);
                if (saved) savedProgress = JSON.parse(saved);
            } catch (e) {
                console.error('Failed to load recipe progress:', e);
            }

            steps.forEach((step, index) => {
                // Wrap existing content
                const content = step.innerHTML;
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.className = 'form-check-input';
                checkbox.setAttribute('data-step', index);

                // Check if this step was previously completed
                if (savedProgress[index]) {
                    checkbox.checked = true;
                    step.classList.add('completed');
                }

                const contentWrapper = document.createElement('span');
                contentWrapper.className = 'step-content';
                contentWrapper.innerHTML = content;

                step.innerHTML = '';
                step.appendChild(checkbox);
                step.appendChild(contentWrapper);

                // Handle checkbox changes
                checkbox.addEventListener('change', function() {
                    if (this.checked) {
                        step.classList.add('completed');
                        savedProgress[index] = true;
                    } else {
                        step.classList.remove('completed');
                        delete savedProgress[index];
                    }

                    // Save progress to localStorage
                    try {
                        localStorage.setItem(storageKey, JSON.stringify(savedProgress));
                    } catch (e) {
                        console.error('Failed to save recipe progress:', e);
                    }
                });
            });
        }

        // Initialize checkboxes and timers when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => {
                initializeStepCheckboxes();
                initializeTimers();
            });
        } else {
            initializeStepCheckboxes();
            initializeTimers();
        }
        </script>
    </div>
</div>
